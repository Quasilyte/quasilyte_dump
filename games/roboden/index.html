<!DOCTYPE html>

<script src="wasm_exec.js"></script>

<div id="app_loader" style="top: 50%; left: 50%; position: fixed;">
    <center><span id="app_loading_progress">0%</span></center>
</div>

<script>

window.addEventListener("load", function() {
    document.body.focus();
});

(async function() {
    const go = new Go();
    const goWasmModule = await _download("main.wasm").arrayBuffer();
    WebAssembly.instantiate(goWasmModule, go.importObject).then(result => {
        document.getElementById("app_loader").remove();
        go.run(result.instance);
    });
})();

function _localStorageAvailable() {
    try {
        const key = `storage__test__`;
        window.localStorage.setItem(key, null);
        window.localStorage.removeItem(key);
        return true;
    } catch (e) {
        return false;
    }
}

function _download(filename) {
    const progressSpan = document.getElementById("app_loading_progress");

    const xhr = new XMLHttpRequest();
    return new Promise((resolve) => {
        xhr.addEventListener("progress", (event) => {
            if (!event.lengthComputable) {
                progressSpan.innerText = "???";
                return
            }
            const progress = (100 * (event.loaded / event.total)) | 0;
            progressSpan.innerText = `${progress}% (${event.loaded}/${event.total})`;
        });
        xhr.addEventListener("onload", () => {
            console.log("loading finished");
            if (xhr.readyState === 4 && xhr.status === 200) {
                resolve(xhr.response);
            }
        });
        xhr.open("GET", filename, true);
    });
}
</script>
